void setBuildStatus(String message, String state) {
    step([
            $class            : "GitHubCommitStatusSetter",
            reposSource       : [$class: "ManuallyEnteredRepositorySource", url: "https://github.com/tardisone/shamu-hrs-company-service.git"],
            contextSource     : [$class: "ManuallyEnteredCommitContextSource", context: "shamu-company-master-build"],
            errorHandlers     : [[$class: "ChangingBuildStatusErrorHandler", result: "UNSTABLE"]],
            statusResultSource: [$class: "ConditionalStatusResultSource", results: [[$class: "AnyBuildResult", message: message, state: state]]]
    ])
}

pipeline {
    agent { label '!master' }
    environment {
        WORKSPACE = "/home/ubuntu/workspace/shamu-company-master-auto-build"
    }
    stages {
        stage('pull shamu-hrs') {
            steps {
                sh 'mkdir -p shamu-hrs'
                dir('shamu-hrs') {
                    git branch: "master",
                    credentialsId: "${credentialsId}",
                    url: 'https://github.com/tardisone/shamu-hrs.git'
                }
            }
        }
        stage('unit tests') {
            steps {
                echo '---------------------------------\n' +
                        '            Unit test            ' +
                        '\n---------------------------------'

                sh "mvn clean test -Dspring.profiles.active=test > junit_output.txt"
            }
        }
        stage('create artifact for dev environment') {
            steps {
                echo '---------------------------------\n' +
                        '      Create artifact         ' +
                        '\n---------------------------------'
                sh "ansible-playbook shamu-hrs/auto-deploy/ansible/create-project-config-files.yml -e 'workspace=${WORKSPACE} stack_prefix=simplyhired-hrs-eastbay env=dev service_name=company'"
                sh "CI/build -e simplyhired-hrs-eastbay-dev -r master"
            }
        }
        stage('deploy company service') {
            steps {
                script {
                    sh "CI/deploy simplyhired-hrs-eastbay-dev master"
                }
            }
        }
    }
    post {
        success {
            setBuildStatus("Build succeeded", "SUCCESS")
        }
        failure {
            setBuildStatus("Build failed", "FAILURE")
        }
    }
}
